---
import MainLayout from '../layouts/Layout.astro'
import SiteList from '../components/SiteList.astro'
import StatsBox from '../components/StatsBox.astro'
import { maxContentSpace } from '../constants/constants'
import { readSupabase } from '../constants/readSupa'
import { getMonthlyViews } from "../constants/shapingData/getMonthlyViews"
import { getCleanData } from "../constants/shapingData/getCleanData"
import { getHighlightsData } from "../constants/shapingData/getHighlightsData"
import { SITES_LIST } from '../constants/data/data'

let fullData = {}
let trafficData = {}

for(let i=0;i<SITES_LIST.length;i++){
	const lowerCaseName = SITES_LIST[i].name.toLowerCase()
	fullData[lowerCaseName] = await readSupabase({tableName:`traffic-${lowerCaseName}`})
}


for(let i=0;i<SITES_LIST.length;i++) {
	const name = SITES_LIST[i].name 
	const lowerCaseName = name.toLowerCase()
	trafficData[lowerCaseName] = {
		title: name,
		link: SITES_LIST[i].subtitle,
		monthlyViews: await getMonthlyViews(fullData[lowerCaseName] as any),
		highlightsData: await getHighlightsData(fullData[lowerCaseName] as any),
		allData: await getCleanData(fullData[lowerCaseName] as any),
		dataAttrVal: lowerCaseName
	}
}

---

<MainLayout title="Webstats: Kushal Kumar Saha">
	<div class={`px-4 md:px-8 ${maxContentSpace} overflow-hidden flex flex-col gap-5 md:pt-4 md:gap-6 md:flex-row items-stretch justify-start md:justify-stretch w-full h-full relative`} >
		<SiteList/>
		<main class="relative grid">
			{ Object.entries(trafficData).map( data => (
				<StatsBox 
					title=			{data[1].title} 
					link=			{data[1].link} 
					monthlyViews=	{data[1].monthlyViews} 
					highlightsData=	{data[1].highlightsData} 
					allData=		{data[1].allData} 
					dataAttrVal=	{data[1].dataAttrVal}
				/>
			)) }
		</main>
	</div>
</MainLayout>
